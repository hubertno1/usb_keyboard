C51 COMPILER V9.54   KEY                                                                   12/05/2024 11:31:51 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\obj\key.obj
COMPILER INVOKED BY: D:\installations\keil_c51\C51\BIN\C51.EXE hal_driver\key.c LARGE OPTIMIZE(6,SPEED) BROWSE INCDIR(.\
                    -hal_driver) DEBUG OBJECTEXTEND PRINT(.\list\key.lst) TABS(2) OBJECT(.\obj\key.obj)

line level    source

   1          #include "key.h"
   2          #include  ".\Public\CH554.H"
   3          #include  ".\Public\debug.h"
   4          
   5          typedef enum {
   6              KEY_STATE_IDLE,
   7              KEY_STATE_DEBOUNCE_PRESS,
   8              KEY_STATE_DEBOUNCE_RELEASE,
   9              KEY_STATE_PRESSED
  10          } key_state_t;
  11          
  12          static key_cb_t key_cb = NULL;
  13          static key_state_t key_state = KEY_STATE_IDLE;
  14          static key_mode_t key_mode;
  15          // static uint32_t debounce_time = 0;
  16          
  17          void key_init(void)
  18          {
  19   1          /* 0000 0001 << 4  ->  0001 0000 */ 
  20   1          P1_MOD_OC |= (1 << 7); // Set P1.4 as open-drain
  21   1          P1_DIR_PU |= (1 << 7); // Set P1.4 as input
  22   1      
  23   1      
  24   1          P1_MOD_OC |= (1 << 1);  // Set P1.7 as open-drain
  25   1          P1_DIR_PU |= (1 << 1);  // Set P1.7 as input
  26   1        
  27   1      
  28   1          if (MODE_PIN == 0)
  29   1          {
  30   2              key_mode = KEY_MODE_EDGE;
  31   2          key_state = KEY_STATE_PRESSED;
  32   2          }
  33   1          else
  34   1          {
  35   2              KEY = 1;
  36   2              key_mode = KEY_MODE_RISING;
  37   2          }
  38   1      
  39   1      }
  40          
  41          void register_key_cb(key_cb_t cb)
  42          {
  43   1          key_cb = cb;
  44   1      }
  45          
  46          static key_event_t get_key_event(void)
  47          {
  48   1          key_event_t event = KEY_EVENT_NONE;
  49   1          switch (key_state)
  50   1          {
  51   2              case KEY_STATE_IDLE:
  52   2              {
  53   3                  if (KEY == 0)
  54   3                      key_state = KEY_STATE_DEBOUNCE_PRESS;
C51 COMPILER V9.54   KEY                                                                   12/05/2024 11:31:51 PAGE 2   

  55   3                  
  56   3                  break;
  57   3              }
  58   2              case KEY_STATE_DEBOUNCE_PRESS:
  59   2              {
  60   3                  /* 后续考虑定时器，这样不会阻塞程序 */
  61   3                  mDelaymS(10);
  62   3                  if (KEY == 0)
  63   3                  {
  64   4                      key_state = KEY_STATE_PRESSED;
  65   4      
  66   4                      if (key_mode == KEY_MODE_EDGE)
  67   4                      {
  68   5                          event = KEY_EVENT_PRESSED;
  69   5                      }
  70   4                  }
  71   3                  else
  72   3                  {
  73   4                      key_state = KEY_STATE_IDLE;
  74   4                  }
  75   3                  break;
  76   3              }
  77   2              case KEY_STATE_PRESSED:
  78   2              {
  79   3                  if (KEY == 1)
  80   3                  {
  81   4                      key_state = KEY_STATE_DEBOUNCE_RELEASE;
  82   4                  }
  83   3                  break;
  84   3              }
  85   2              case KEY_STATE_DEBOUNCE_RELEASE:
  86   2              {
  87   3                  mDelaymS(10);
  88   3                  if (KEY == 1)
  89   3                  {
  90   4                      key_state = KEY_STATE_IDLE;
  91   4                      event = KEY_EVENT_RELEASED;
  92   4                  }
  93   3                  else
  94   3                  {
  95   4                      key_state = KEY_STATE_PRESSED;
  96   4                  }
  97   3                  break;
  98   3              }
  99   2      
 100   2              default:
 101   2              {
 102   3                  key_state = KEY_STATE_IDLE;
 103   3                  break;
 104   3              }
 105   2      
 106   2          }
 107   1      
 108   1          return event;
 109   1      }
 110          
 111          void key_scan(void)
 112          {
 113   1          key_event_t evt = get_key_event();
 114   1          if (evt != KEY_EVENT_NONE && key_cb != NULL)
 115   1              key_cb(evt);
 116   1      }
C51 COMPILER V9.54   KEY                                                                   12/05/2024 11:31:51 PAGE 3   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    196    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      5       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
