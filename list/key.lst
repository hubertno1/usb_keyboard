C51 COMPILER V9.54   KEY                                                                   12/02/2024 10:23:19 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\obj\key.obj
COMPILER INVOKED BY: D:\installations\keil_c51\C51\BIN\C51.EXE hal_driver\key.c LARGE OPTIMIZE(6,SPEED) BROWSE INCDIR(.\
                    -hal_driver) DEBUG OBJECTEXTEND PRINT(.\list\key.lst) TABS(2) OBJECT(.\obj\key.obj)

line level    source

   1          #include "key.h"
   2          #include  ".\Public\CH554.H"
   3          #include  ".\Public\debug.h"
   4          
   5          typedef enum {
   6              KEY_STATE_IDLE,
   7              KEY_STATE_DEBOUNCE_PRESS,
   8              KEY_STATE_DEBOUNCE_RELEASE,
   9              KEY_STATE_PRESSED
  10          } key_state_t;
  11          
  12          static key_cb_t key_cb = NULL;
  13          static key_state_t key_state = KEY_STATE_IDLE;
  14          static key_mode_t key_mode;
  15          // static uint32_t debounce_time = 0;
  16          
  17          void key_init(void)
  18          {
  19   1          /* 0000 0001 << 4  ->  0001 0000 */ 
  20   1          P1_MOD_OC |= (1 << 7); // Set P1.4 as open-drain
  21   1          P1_DIR_PU |= (1 << 7); // Set P1.4 as input
  22   1      
  23   1      
  24   1          P1_MOD_OC |= (1 << 1);  // Set P1.7 as open-drain
  25   1          P1_DIR_PU |= (1 << 1);  // Set P1.7 as input
  26   1        
  27   1      
  28   1          if (MODE_PIN == 0)
  29   1          {
  30   2              key_mode = KEY_MODE_EDGE;
  31   2          key_state = KEY_STATE_PRESSED;
  32   2          }
  33   1          else
  34   1          {
  35   2              key_mode = KEY_MODE_RISING;
  36   2          }
  37   1      
  38   1      }
  39          
  40          void register_key_cb(key_cb_t cb)
  41          {
  42   1          key_cb = cb;
  43   1      }
  44          
  45          static key_event_t get_key_event(void)
  46          {
  47   1          key_event_t event = KEY_EVENT_NONE;
  48   1          switch (key_state)
  49   1          {
  50   2              case KEY_STATE_IDLE:
  51   2              {
  52   3                  if (KEY == 0)
  53   3                      key_state = KEY_STATE_DEBOUNCE_PRESS;
  54   3                  
C51 COMPILER V9.54   KEY                                                                   12/02/2024 10:23:19 PAGE 2   

  55   3                  break;
  56   3              }
  57   2              case KEY_STATE_DEBOUNCE_PRESS:
  58   2              {
  59   3                  /* 后续考虑定时器，这样不会阻塞程序 */
  60   3                  mDelaymS(10);
  61   3                  if (KEY == 0)
  62   3                  {
  63   4                      key_state = KEY_STATE_PRESSED;
  64   4      
  65   4                      if (key_mode == KEY_MODE_EDGE)
  66   4                      {
  67   5                          event = KEY_EVENT_PRESSED;
  68   5                      }
  69   4                  }
  70   3                  else
  71   3                  {
  72   4                      key_state = KEY_STATE_IDLE;
  73   4                  }
  74   3                  break;
  75   3              }
  76   2              case KEY_STATE_PRESSED:
  77   2              {
  78   3                  if (KEY == 1)
  79   3                  {
  80   4                      key_state = KEY_STATE_DEBOUNCE_RELEASE;
  81   4                  }
  82   3                  break;
  83   3              }
  84   2              case KEY_STATE_DEBOUNCE_RELEASE:
  85   2              {
  86   3                  mDelaymS(10);
  87   3                  if (KEY == 1)
  88   3                  {
  89   4                      key_state = KEY_STATE_IDLE;
  90   4                      event = KEY_EVENT_RELEASED;
  91   4                  }
  92   3                  else
  93   3                  {
  94   4                      key_state = KEY_STATE_PRESSED;
  95   4                  }
  96   3                  break;
  97   3              }
  98   2      
  99   2              default:
 100   2              {
 101   3                  key_state = KEY_STATE_IDLE;
 102   3                  break;
 103   3              }
 104   2      
 105   2          }
 106   1      
 107   1          return event;
 108   1      }
 109          
 110          void key_scan(void)
 111          {
 112   1          key_event_t evt = get_key_event();
 113   1          if (evt != KEY_EVENT_NONE && key_cb != NULL)
 114   1              key_cb(evt);
 115   1      }

C51 COMPILER V9.54   KEY                                                                   12/02/2024 10:23:19 PAGE 3   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    194    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      5       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
