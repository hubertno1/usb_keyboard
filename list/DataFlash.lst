C51 COMPILER V9.54   DATAFLASH                                                             12/06/2024 17:28:23 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DATAFLASH
OBJECT MODULE PLACED IN .\obj\DataFlash.obj
COMPILER INVOKED BY: D:\installations\keil_c51\C51\BIN\C51.EXE hal_driver\DataFlash.C LARGE OPTIMIZE(6,SPEED) BROWSE INC
                    -DIR(.\hal_driver) DEBUG OBJECTEXTEND PRINT(.\list\DataFlash.lst) TABS(2) OBJECT(.\obj\DataFlash.obj)

line level    source

   1          /********************************** (C) COPYRIGHT *******************************
   2          * File Name          : DataFlash.C
   3          * Author             : WCH
   4          * Version            : V1.0
   5          * Date               : 2017/01/20
   6          * Description        : CH554 DataFlash字节读写函数定义   
   7          *******************************************************************************/
   8          
   9          #include "..\Public\CH554.H"                                                         
  10          #include "..\Public\Debug.H"
  11          #include "DataFlash.H"
  12          
  13          /*******************************************************************************
  14          * Function Name  : WriteDataFlash(UINT8 Addr,PUINT8 buf,UINT8 len)
  15          * Description    : DataFlash写
  16          * Input          : UINT8 Addr，PUINT16 buf,UINT8 len
  17          * Output         : None
  18          * Return         : UINT8 i 返回写入长度
  19          *******************************************************************************/
  20          UINT8 WriteDataFlash(UINT8 Addr,PUINT8 buf,UINT8 len)
  21          {
  22   1          UINT8 i;
  23   1          SAFE_MOD = 0x55;
  24   1          SAFE_MOD = 0xAA;                                                           //进入安全模式
  25   1          GLOBAL_CFG |= bDATA_WE;                                                    //使能DataFlash写
  26   1          SAFE_MOD = 0;                                                              //退出安全模式 
  27   1          ROM_ADDR_H = DATA_FLASH_ADDR >> 8;
  28   1          Addr <<= 1;
  29   1          for(i=0;i<len;i++)
  30   1          {
  31   2              ROM_ADDR_L = Addr + i*2;
  32   2              ROM_DATA_L = *(buf+i);      
  33   2              if ( ROM_STATUS & bROM_ADDR_OK ) {                                     // 操作地址有效
  34   3                 ROM_CTRL = ROM_CMD_WRITE;                                           // 写入
  35   3              }
  36   2              if((ROM_STATUS ^ bROM_ADDR_OK) > 0) return i;                          // 返回状态,0x00=success,  
             -0x02=unknown command(bROM_CMD_ERR)
  37   2          }
  38   1          SAFE_MOD = 0x55;
  39   1          SAFE_MOD = 0xAA;                                                           //进入安全模式
  40   1          GLOBAL_CFG &= ~bDATA_WE;                                                   //开启DataFlash写保护
  41   1          SAFE_MOD = 0;                                                              //退出安全模式 
  42   1          return i;   
  43   1      }
  44          
  45          /*******************************************************************************
  46          * Function Name  : ReadDataFlash(UINT8 Addr,UINT8 len,PUINT8 buf)
  47          * Description    : 读DataFlash
  48          * Input          : UINT8 Addr UINT8 len PUINT8 buf
  49          * Output         : None
  50          * Return         : UINT8 i 返回写入长度
  51          *******************************************************************************/
  52          UINT8 ReadDataFlash(UINT8 Addr,UINT8 len,PUINT8 buf)
  53          {
C51 COMPILER V9.54   DATAFLASH                                                             12/06/2024 17:28:23 PAGE 2   

  54   1          UINT8 i;
  55   1          ROM_ADDR_H = DATA_FLASH_ADDR >> 8;
  56   1          Addr <<= 1;
  57   1          for(i=0;i<len;i++){
  58   2          ROM_ADDR_L = Addr + i*2;                                                   //Addr必须为偶地址
  59   2          ROM_CTRL = ROM_CMD_READ;
  60   2      //     if ( ROM_STATUS & bROM_CMD_ERR ) return( 0xFF );                        // unknown command
  61   2          *(buf+i) = ROM_DATA_L;
  62   2          }
  63   1          return i;
  64   1      }
  65          
  66          
  67          /*******************************************************************************
  68          * Function Name  : EraseDataFlash(UINT8 Addr, UINT8 len)
  69          * Description    : 擦除DataFlash指定区域
  70          * Input          : UINT8 Addr：起始地址, UINT8 len：要擦除的长度(字节数) 
  71          * Output         : None
  72          * Return         : UINT8 erasedLen: 实际擦除的长度
  73          *******************************************************************************/
  74          UINT8 EraseDataFlash(UINT8 Addr, UINT8 len)
  75          {
  76   1          UINT8 i;
  77   1          UINT8 erasedLen = 0;
  78   1          
  79   1          SAFE_MOD = 0x55;
  80   1          SAFE_MOD = 0xAA;                                                           //进入安全模式
  81   1          GLOBAL_CFG |= bDATA_WE;                                                    //使能DataFlash写
  82   1          SAFE_MOD = 0;                                                              //退出安全模式 
  83   1          ROM_ADDR_H = DATA_FLASH_ADDR >> 8;
  84   1          
  85   1          Addr <<= 1;                                                                //将实际地址转为偶地址
  86   1          for(i=0; i<len; i++)
  87   1          {
  88   2              ROM_ADDR_L = Addr + i*2;
  89   2              ROM_DATA_L = 0xFF;                                                     //连续写入0xFF     
  90   2              if ( ROM_STATUS & bROM_ADDR_OK ) {                                     // 操作地址有效
  91   3                 ROM_CTRL = ROM_CMD_WRITE;                                           // 启动写操作
  92   3                 erasedLen++;                                                        //擦除长度加1
  93   3              } else {
  94   3                 break;                                                              //地址无效时退出擦除
  95   3              }
  96   2          }
  97   1          
  98   1          SAFE_MOD = 0x55;
  99   1          SAFE_MOD = 0xAA;                                                           //进入安全模式
 100   1          GLOBAL_CFG &= ~bDATA_WE;                                                   //禁止DataFlash写
 101   1          SAFE_MOD = 0;                                                              //退出安全模式
 102   1          
 103   1          return erasedLen;   
 104   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    237    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.54   DATAFLASH                                                             12/06/2024 17:28:23 PAGE 3   


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
