C51 COMPILER V9.54   TIMER                                                                 12/06/2024 15:33:22 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN .\obj\Timer.obj
COMPILER INVOKED BY: D:\installations\keil_c51\C51\BIN\C51.EXE hal_driver\Timer.C LARGE OPTIMIZE(6,SPEED) BROWSE INCDIR(
                    -.\hal_driver) DEBUG OBJECTEXTEND PRINT(.\list\Timer.lst) TABS(2) OBJECT(.\obj\Timer.obj)

line level    source

   1          
   2          /********************************** (C) COPYRIGHT *******************************
   3          * File Name          : Timer.C
   4          * Author             : WCH
   5          * Version            : V1.0
   6          * Date               : 2017/01/20
   7          * Description        : CH554 Time ³õÊ¼»¯¡¢¶¨Ê±Æ÷¡¢¼ÆÊýÆ÷¸³Öµ¡¢T2²¶×½¹¦ÄÜ¿ªÆôº¯ÊýµÈ
   8                                 ¶¨Ê±Æ÷ÖÐ¶Ïº¯Êý                    
   9          *******************************************************************************/
  10          #include ".\Public\CH554.H"                                                  
  11          #include ".\Public\Debug.H"
  12          #include "Timer.H" 
  13          #include "stdio.h"
  14          #include "compound.h"
  15          
  16          
  17          #pragma  NOAREGS
  18          
  19          static timer_cb_t timer0_cb = NULL;
  20          
  21          /*******************************************************************************
  22          * Function Name  : mTimer_x_ModInit(UINT8 x ,UINT8 mode)
  23          * Description    : CH554¶¨Ê±¼ÆÊýÆ÷xÄ£Ê½ÉèÖÃ
  24          * Input          : UINT8 mode,TimerÄ£Ê½Ñ¡Ôñ
  25                             0£ºÄ£Ê½0£¬13Î»¶¨Ê±Æ÷£¬TLnµÄ¸ß3Î»ÎÞÐ§
  26                             1£ºÄ£Ê½1£¬16Î»¶¨Ê±Æ÷
  27                             2£ºÄ£Ê½2£¬8Î»×Ô¶¯ÖØ×°¶¨Ê±Æ÷
  28                             3£ºÄ£Ê½3£¬Á½¸ö8Î»¶¨Ê±Æ÷  Timer0
  29                             3£ºÄ£Ê½3£¬Timer1Í£Ö¹                  
  30          * Output         : None
  31          * Return         : ³É¹¦  SUCCESS
  32                             Ê§°Ü  FAIL
  33          *******************************************************************************/
  34          UINT8 mTimer_x_ModInit(UINT8 x ,UINT8 mode)
  35          {
  36   1          if(x == 0){TMOD = TMOD & 0xf0 | mode;}
  37   1          else if(x == 1){TMOD = TMOD & 0x0f | (mode<<4);}
  38   1          else if(x == 2){RCLK = 0;TCLK = 0;CP_RL2 = 0;}                               //16Î»×Ô¶¯ÖØÔØ¶¨Ê±Æ÷
  39   1          else return FAIL;
  40   1          return SUCCESS;
  41   1      }
  42          
  43          /*******************************************************************************
  44          * Function Name  : mTimer_x_SetData(UINT8 x,UINT16 dat)
  45          * Description    : CH554Timer0 TH0ºÍTL0¸³Öµ
  46          * Input          : UINT16 dat;¶¨Ê±Æ÷¸³Öµ
  47          * Output         : None
  48          * Return         : None
  49          *******************************************************************************/
  50          void mTimer_x_SetData(UINT8 x,UINT16 dat)
  51          {
  52   1          UINT16 tmp;
  53   1          tmp = 65536 - dat;  
  54   1          if(x == 0){TL0 = tmp & 0xff;TH0 = (tmp>>8) & 0xff;}
C51 COMPILER V9.54   TIMER                                                                 12/06/2024 15:33:22 PAGE 2   

  55   1          else if(x == 1){TL1 = tmp & 0xff;TH1 = (tmp>>8) & 0xff;}
  56   1          else if(x == 2){
  57   2            RCAP2L = TL2 = tmp & 0xff;                                               //16Î»×Ô¶¯ÖØÔØ¶¨Ê±Æ÷
  58   2            RCAP2H = TH2 = (tmp>>8) & 0xff;
  59   2          }                                                 
  60   1      }
  61          
  62          /*******************************************************************************
  63          * Function Name  : CAP2Init(UINT8 mode)
  64          * Description    : CH554¶¨Ê±¼ÆÊýÆ÷2 T2EXÒý½Å²¶×½¹¦ÄÜ³õÊ¼»¯
  65                             UINT8 mode,±ßÑØ²¶×½Ä£Ê½Ñ¡Ôñ
  66                             0:T2ex´ÓÏÂ½µÑØµ½ÏÂÒ»¸öÏÂ½µÑØ
  67                             1:T2exÈÎÒâ±ßÑØÖ®¼ä
  68                             3:T2ex´ÓÉÏÉýÑØµ½ÏÂÒ»¸öÉÏÉýÑØ
  69          * Input          : None
  70          * Output         : None
  71          * Return         : None
  72          *******************************************************************************/
  73          void CAP2Init(UINT8 mode)
  74          {
  75   1          RCLK = 0;
  76   1          TCLK = 0; 
  77   1          C_T2  = 0;
  78   1          EXEN2 = 1; 
  79   1          CP_RL2 = 1;                                                                //Æô¶¯T2exµÄ²¶×½¹¦ÄÜ
  80   1          T2MOD |= mode << 2;                                                        //±ßÑØ²¶×½Ä£Ê½Ñ¡Ôñ
  81   1      }
  82          
  83          /*******************************************************************************
  84          * Function Name  : CAP1Init(UINT8 mode)
  85          * Description    : CH554¶¨Ê±¼ÆÊýÆ÷2 T2Òý½Å²¶×½¹¦ÄÜ³õÊ¼»¯T2
  86                             UINT8 mode,±ßÑØ²¶×½Ä£Ê½Ñ¡Ôñ
  87                             0:T2ex´ÓÏÂ½µÑØµ½ÏÂÒ»¸öÏÂ½µÑØ
  88                             1:T2exÈÎÒâ±ßÑØÖ®¼ä
  89                             3:T2ex´ÓÉÏÉýÑØµ½ÏÂÒ»¸öÉÏÉýÑØ
  90          * Input          : None
  91          * Output         : None
  92          * Return         : None
  93          *******************************************************************************/
  94          void CAP1Init(UINT8 mode)
  95          {
  96   1          RCLK = 0;
  97   1          TCLK = 0;
  98   1          CP_RL2 = 1;
  99   1          C_T2 = 0;
 100   1          T2MOD = T2MOD & ~T2OE | (mode << 2) | bT2_CAP1_EN;                         //Ê¹ÄÜT2Òý½Å²¶×½¹¦ÄÜ,±ßÑØ²¶
             -×½Ä£Ê½Ñ¡Ôñ
 101   1      }
 102          
 103          //#ifdef T0_INT
 104          ///*******************************************************************************
 105          //* Function Name  : mTimer0Interrupt()
 106          //* Description    : CH554¶¨Ê±¼ÆÊýÆ÷0¶¨Ê±¼ÆÊýÆ÷ÖÐ¶Ï´¦Àíº¯Êý
 107          //*******************************************************************************/
 108          //void  mTimer0Interrupt( void ) interrupt INT_NO_TMR0 using 1                //timer0ÖÐ¶Ï·þÎñ³ÌÐò,Ê¹ÓÃ¼Ä´æ
             -Æ÷×é1
 109          //{                                                                           //·½Ê½3Ê±£¬TH0Ê¹ÓÃTimer1µÄÖÐ
             -¶Ï×ÊÔ´
 110          //    SCK = ~SCK;
 111          //    printf("t0 interrupt\n");
 112          ////     mTimer_x_SetData(0,0x0000);                                          //·Ç×Ô¶¯ÖØÔØ·½Ê½ÐèÖØÐÂ¸øTH0º
             -ÍTL0¸³Öµ      
C51 COMPILER V9.54   TIMER                                                                 12/06/2024 15:33:22 PAGE 3   

 113          //}
 114          //#endif
 115          
 116          #ifdef T1_INT
              /*******************************************************************************
              * Function Name  : mTimer1Interrupt()
              * Description    : CH554¶¨Ê±¼ÆÊýÆ÷0¶¨Ê±¼ÆÊýÆ÷ÖÐ¶Ï´¦Àíº¯Êý
              *******************************************************************************/
              void  mTimer1Interrupt( void ) interrupt INT_NO_TMR1 using 2                //timer1ÖÐ¶Ï·þÎñ³ÌÐò,Ê¹ÓÃ¼Ä´æÆ÷
             -×é2
              {                                                                           //·½Ê½3Ê±£¬Timer1Í£Ö¹
                  SCK = ~SCK;
              //     mTimer_x_SetData(1,0x0000);                                          //·Ç×Ô¶¯ÖØÔØ·½Ê½ÐèÖØÐÂ¸øTH1ºÍT
             -L1¸³Öµ      
              }
              #endif
 127          
 128          #ifdef T2_INT
              /*******************************************************************************
              * Function Name  : mTimer2Interrupt()
              * Description    : CH554¶¨Ê±¼ÆÊýÆ÷0¶¨Ê±¼ÆÊýÆ÷ÖÐ¶Ï´¦Àíº¯Êý
              *******************************************************************************/
              void  mTimer2Interrupt( void ) interrupt INT_NO_TMR2 using 3                //timer2ÖÐ¶Ï·þÎñ³ÌÐò,Ê¹ÓÃ¼Ä´æÆ÷
             -×é3
              {                                                                             
                  mTimer2RunCTL( 0 );                                                     //¹Ø¶¨Ê±Æ÷
              #ifdef  T2_CAP   
                  if(EXF2)                                                                //T2exµçÆ½±ä»¯ÖÐ¶ÏÖÐ¶Ï±êÖ¾
                  {
                      SCK = ~SCK;                                                         //P17µçÆ½Ö¸Ê¾¼à¿Ø
                      Cap[FLAG++] = RCAP2;                                                //T2EX
                      printf("RCAP2 %04x  \n",RCAP2);                                       
                      EXF2 = 0;                                                           //Çå¿ÕT2ex²¶×½ÖÐ¶Ï±êÖ¾    
                  }
                  if(CAP1F)                                                               //T2µçÆ½²¶×½ÖÐ¶Ï±êÖ¾
                  {
                      Cap[FLAG++] = T2CAP1;                                               //T2;     
                      printf("T2CAP1 %04x  \n",T2CAP1);       
                      CAP1F = 0;                                                          //Çå¿ÕT2²¶×½ÖÐ¶Ï±êÖ¾
                  }
              #endif  
                  if(TF2)
                  {
                      TF2 = 0;                                                             //Çå¿Õ¶¨Ê±Æ÷2Òç³öÖÐ¶Ï         
             -                                               
                      SCK = ~SCK;                                                          //P17µçÆ½Ö¸Ê¾¼à¿Ø
                  }
                  mTimer2RunCTL( 1 );                                                      //¿ª¶¨Ê±Æ÷   
              }
              #endif
 159          
 160          void timer0_register_cb(timer_cb_t cb)
 161          {
 162   1          timer0_cb = cb;
 163   1      }
 164          
 165          void timer0_init_10ms(void)
 166          {
 167   1          // T2MOD &= ~bT0_CLK: Ñ¡Ôñ±ê×¼Ê±ÖÓ Fsys/12
 168   1          mTimer0Clk12DivFsys();  // 12MHz/12 = 1MHz = 1us Ã¿¼ÆÊý
 169   1      
 170   1          // ÉèÖÃ16Î»¶¨Ê±Æ÷Ä£Ê½    
C51 COMPILER V9.54   TIMER                                                                 12/06/2024 15:33:22 PAGE 4   

 171   1          mTimer_x_ModInit(0,1);   
 172   1      
 173   1          // ¼ÆËã10msËùÐè¼ÆÊýÖµ:
 174   1          // 10ms = 10000us
 175   1          // ËùÒÔ¼ÆÊýÖµ = 65536 - 10000 = 0xD8F0
 176   1          mTimer_x_SetData(0,0xD8F0);  // ÐÞ¸Ä¼ÆÊýÖµÎª0xD8F0
 177   1      
 178   1          mTimer0RunCTL(1);
 179   1          ET0 = 1;    
 180   1      
 181   1      }
 182          
 183          #ifdef T0_INT
 184          void mTimer0Interrupt(void) interrupt INT_NO_TMR0 using 1
 185          {
 186   1          mTimer_x_SetData(0,0xD8F0);
 187   1          if (timer0_cb)
 188   1          {
 189   2              timer0_cb();
 190   2          }
 191   1      
 192   1          if (learnmatch_state == LEARNMATCH_STATE_ACTIVE)
 193   1          {
 194   2              if (++ g_learnmatch_timer >= 80)  // 400
 195   2              {
 196   3                  WL_LEARN_PIN = 1;
 197   3                  learnmatch_state = LEARNMATCH_STATE_IDLE;
 198   3                  g_learnmatch_timer = 0;
 199   3              }
 200   2          }
 201   1      
 202   1          if (cleanmatch_state == CLEANMATCH_STATE_ACTIVE)
 203   1          {
 204   2              if (++ g_cleanmatch_timer >= 220) // 1100
 205   2              {
 206   3                  WL_LEARN_PIN = 1;
 207   3                  cleanmatch_state = CLEANMATCH_STATE_IDLE;
 208   3                  g_cleanmatch_timer = 0;
 209   3              }
 210   2          }
 211   1      }
 212          
 213          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    324    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
